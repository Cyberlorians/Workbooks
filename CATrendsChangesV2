{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "toolbar",
        "links": [
          {
            "id": "18289c31-463f-48ea-b452-4244b147912f",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Conditional Access Trends",
            "subTarget": "cap1",
            "preText": "",
            "style": "link",
            "icon": "trendup"
          },
          {
            "id": "f74be862-4160-4e7c-9c32-1e55ef62c6ae",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Conditional Access Security & Monitoring",
            "subTarget": "cap3",
            "style": "link",
            "icon": "Monitoring"
          }
        ]
      },
      "name": "links - 1"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "38660ba6-7173-4395-8c08-b477161f5bfc",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": "/subscriptions/d75e3576-9a3a-4f5b-b112-b5e0088cd2e1/resourceGroups/Sentinel/providers/Microsoft.OperationalInsights/workspaces/Sentinel-Cyberlorians"
          },
          {
            "id": "e327ae2b-6659-4d53-98d7-7326e30a893a",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 7776000000
            }
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap3"
      },
      "name": "parameters - TimeRange",
      "styleSettings": {
        "margin": "0",
        "padding": "0"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Conditional Access Security",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Conditional Access Emergency Account - Creation\r\n\r\n#### What is an Emergency Account (break glass) and do organizations need to [manage](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/security-emergency-access?WT.mc_id=Portal-fx) emergency access? \r\n*It is important that you prevent being accidentally locked out of your Microsoft Entra organization because you can't sign in or activate another user's account as an administrator. You can mitigate the impact of accidental lack of administrative access by creating two or more emergency access accounts in your organization.*\r\n\r\n*Emergency access accounts are highly privileged, and they are not assigned to specific individuals. Emergency access accounts are limited to emergency or \"break glass\"' scenarios where normal administrative accounts can't be used. We recommend that you maintain a goal of restricting emergency account use to only the times when it is absolutely necessary.* \r\n\r\n#### **Step:1** - Create break glass accounts according to Microsoft [documentation](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/security-emergency-access?WT.mc_id=Portal-fx#how-to-create-an-emergency-access-account).\r\n\r\n#### Deploy [AutoCAPExclude](https://github.com/Cyberlorians/Articles/blob/main/AutoExcludeCAP.md) for automation of an Exclusion group being added to all policies. It is suggested to set recurrence  every 1-5m in corporate orgs.\r\n",
                    "style": "info"
                  },
                  "conditionalVisibility": {
                    "parameterName": "Tab",
                    "comparison": "isEqualTo",
                    "value": "cap3"
                  },
                  "name": "Conditional Access Emergency Account - Creation"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Conditional Access Emergency Account - Monitor SignIn\r\n\r\n#### **Step:2** - Monitor SignIn events of the Emergency accounts and create alert rules. Follow guidance for an [Alert Rule](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/security-emergency-access?WT.mc_id=Portal-fx#create-an-alert-rule) in Azure Monitor.\r\n####  **Microsoft Sentinel** customers. It is advised to create an Analytical Rule for tracking the usage of the emergency accounts. Please review this [document](https://jeffreyappel.nl/monitor-azure-ad-break-glass-accounts-with-azure-sentinel/).\r\n\r\n*Enter any UPN or UserID values in the parameters below. The reason for 2x (UserPrincipalName) OR (UserId) is due to the guidance of having only two accounts.*",
                    "style": "info"
                  },
                  "name": "onditional Access Emergency Account - Monitor SignIn"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "6beb74d1-eeb0-4507-bcbb-7e37f96187a9",
                        "version": "KqlParameterItem/1.0",
                        "name": "UPN1",
                        "type": 1,
                        "description": "Enter UPN Value",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": ""
                      },
                      {
                        "version": "KqlParameterItem/1.0",
                        "name": "UPN2",
                        "type": 1,
                        "description": "Enter UPN Value",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": "",
                        "id": "7ee36d59-2e33-4fb7-bd55-d8d6c15387e2"
                      },
                      {
                        "version": "KqlParameterItem/1.0",
                        "name": "UserID1",
                        "type": 1,
                        "description": "Enter UserID Value",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": "",
                        "id": "aba3d160-5f40-453a-957f-75ddc7b04d72"
                      },
                      {
                        "version": "KqlParameterItem/1.0",
                        "name": "UserID2",
                        "type": 1,
                        "description": "Enter UserID Value",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "id": "8efd981b-6c68-4b80-9d94-fc31a1480ac6"
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "customWidth": "50",
                  "name": "parameters - 6"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Search for a single UserPrincipalName\r\nSigninLogs\r\n| where UserPrincipalName ==  ('{UPN1}') or UserPrincipalName ==  ('{UPN2}') or UserId == ('{UserID1}') or UserId == ('{UserID2}') \r\n| distinct TimeGenerated, UserPrincipalName, UserId\r\n| sort by TimeGenerated desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Emergency Accounts, SignIn Events",
                    "noDataMessage": "Please enter UPN or UserId values to track Emergency Account SignIns",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ]
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "Emergency Accounts, SignIn Events"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Conditional Access Emergency Account - Managing Emergency accounts with Automation\r\n\r\n*Managing emergency accounts is the Identity teams responsiblity and they are to be sure these accounts are excluded from Conditional Access to mitigate any type of lockouts due to configuration mistakes from other admins or threat actors. To mitigate this, automation can be deployed.\r\n\r\n#### **Step:3** - Create an Entra Security group called 'Exclude - BG'. *Disclaimer - the identity team can change this name but be sure to add the proper group name in the automation variable.*\r\n\r\n#### **Step:4** - Deploy [AutoCAPExclude](https://github.com/Cyberlorians/Articles/blob/main/AutoExcludeCAP.md).\r\n\r\n\r\n#### **Step:5** - After completion and a successful run of [AutoCAPExclude](https://github.com/Cyberlorians/Articles/blob/main/AutoExcludeCAP.md). It is important to track changes to the Emergency group. In the below parameter labeled 'Enter Exclusion Group'",
                    "style": "info"
                  },
                  "name": "Conditional Access Emergency Account - Managing Emergency accounts with Automation"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "05ef3b6b-055a-4744-98b7-e569dc827d15",
                        "version": "KqlParameterItem/1.0",
                        "name": "ExclusionGroup",
                        "label": "Enter Exclusion Group",
                        "type": 1,
                        "description": "Enter the exclusion group from your access policies",
                        "isRequired": true,
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": "Exclude - BG"
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "conditionalVisibility": {
                    "parameterName": "Tab",
                    "comparison": "isEqualTo",
                    "value": "cap3"
                  },
                  "name": "parameters - 12"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AuditLogs\r\n    //| where OperationName == \"Add member to group\"\r\n    | where OperationName contains_cs \"group\"\r\n    | extend Actor = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\r\n    | extend Target = tostring(TargetResources[0].userPrincipalName)\r\n    | extend GroupName = tostring(parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue)))\r\n    //| where GroupName has \"Exclude\" //enter exlusion group name\r\n    | where GroupName contains ('{ExclusionGroup}')\r\n    | extend GroupID = tostring(TargetResources[1].id)\r\n    | project TimeGenerated, Actor, OperationName, Target, GroupName, GroupID",
                    "size": 1,
                    "title": "Conditional Access Exclusion Group Changes - click to view CA updates",
                    "timeContextFromParameter": "TimeRange",
                    "exportFieldName": "GroupID",
                    "exportParameterName": "guid",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "gridSettings": {
                      "sortBy": [
                        {
                          "itemKey": "TimeGenerated",
                          "sortOrder": 2
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "TimeGenerated",
                        "sortOrder": 2
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "Tab",
                    "comparison": "isEqualTo",
                    "value": "cap3"
                  },
                  "name": "Conditional Access Exclusion Group Changes - click to view CA updates"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AuditLogs\r\n    | where OperationName in (\"Update conditional access policy\")\r\n    | extend Policy=todynamic(tostring(TargetResources[0].modifiedProperties[0].newValue))\r\n   //| mv-expand tostring(parse_json(tostring(parse_json(tostring(parse_json(tostring(Policy.conditions)).users)).excludeGroups)))\r\n| extend Exclude = todynamic(parse_json(tostring(parse_json(tostring(parse_json(tostring(Policy.conditions)).users)))))\r\n| extend Policy = tostring(Policy.displayName)\r\n| extend ['Group Added to Exlusion'] = tostring(parse_json(tostring(Exclude.excludeGroups))[0])\r\n| where ['Group Added to Exlusion'] contains ('{guid}')\r\n| project  TimeGenerated, Policy, ['Group Added to Exlusion'], OperationName\r\n| sort by TimeGenerated desc",
                    "size": 0,
                    "title": "Verifying AutoExclude Exclusions",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "conditionalVisibility": {
                    "parameterName": "guid",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Verifying AutoExclude Exclusions"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "cap3"
            },
            "name": "Emergency Account Tracking"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap3"
      },
      "name": "Conditional Access Security"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Conditional Access Monitoring",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where OperationName in (\"Add conditional access policy\", \"Update conditional access policy\", \"Delete conditional access policy\")\r\n| summarize count() by OperationName, bin(TimeGenerated, 1d)",
              "size": 0,
              "title": "Conditional Access Change History",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "barchart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Update conditional access policy",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Add conditional access policy",
                    "color": "green"
                  },
                  {
                    "seriesName": "Delete conditional access policy",
                    "color": "redBright"
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "cap3"
            },
            "name": "query - changehistory",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where OperationName  in (\"Add conditional access policy\", \"Update conditional access policy\", \"Delete conditional access policy\")\r\n| mv-expand InitiatedBy\r\n| project HumanActor=tostring(InitiatedBy.user.userPrincipalName), NonHumanActor=Identity, OperationName\r\n| summarize Total=count() by HumanActor, NonHumanActor, OperationName\r\n| order by Total desc\r\n",
              "size": 1,
              "title": "Conditional Access Top Editors",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "modifiedBy",
              "exportParameterName": "modifiedBy",
              "exportDefaultValue": "*",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "count_",
                    "formatter": 1,
                    "formatOptions": {
                      "aggregation": "Count"
                    }
                  }
                ]
              },
              "sortBy": [],
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "modifiedBy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              }
            },
            "customWidth": "45",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "cap3"
            },
            "name": "Conditional Access Top Editors",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where OperationName  in (\"Add conditional access policy\", \"Update conditional access policy\", \"Delete conditional access policy\")\r\n| project TimeGenerated, Operation=OperationName, Policy=TargetResources[0].displayName, HumanActor=InitiatedBy.user.userPrincipalName, NonHumanActor=Identity, CorrelationId \r\n| order by TimeGenerated desc",
              "size": 0,
              "title": "Conditional Access Change Log (click for comparison)",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "CorrelationId",
              "exportParameterName": "SelectedCorrelationId",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "cap3"
            },
            "name": "Conditional Access Change Log (click for comparison)",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let OldPolicy = AuditLogs\r\n| where CorrelationId == \"{SelectedCorrelationId}\"\r\n| where OperationName  in (\"Add conditional access policy\", \"Update conditional access policy\", \"Delete conditional access policy\")\r\n| extend Policy=todynamic(tostring(TargetResources[0].modifiedProperties[0].oldValue))\r\n| project Policy\r\n| extend version=\"OldVersion\"\r\n;\r\nlet NewPolicy = AuditLogs\r\n| where CorrelationId == \"{SelectedCorrelationId}\"\r\n| where OperationName  in (\"Add conditional access policy\", \"Update conditional access policy\", \"Delete conditional access policy\")\r\n| extend Policy=todynamic(tostring(TargetResources[0].modifiedProperties[0].newValue))\r\n| project Policy\r\n| extend version=\"NewVersion\"\r\n;\r\nunion OldPolicy, NewPolicy\r\n| order by version asc\r\n| extend grantControls = todynamic(\"\")\r\n| extend sessionControls = todynamic(\"\")\r\n| evaluate bag_unpack(Policy, columnsConflict='replace_source')\r\n| evaluate bag_unpack(conditions, columnsConflict='replace_source')\r\n| evaluate bag_unpack(grantControls, columnsConflict='replace_source')\r\n| evaluate bag_unpack(sessionControls, columnsConflict='replace_source')\r\n| project-away id",
              "size": 0,
              "title": "Conditional Access Change Comparison",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "TenantId",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "DurationMs",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "TenantId",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "DurationMs",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "mapSettings": {
                "locInfo": "LatLong"
              }
            },
            "conditionalVisibilities": [
              {
                "parameterName": "SelectedCorrelationId",
                "comparison": "isNotEqualTo"
              },
              {
                "parameterName": "Tab",
                "comparison": "isEqualTo",
                "value": "cap3"
              }
            ],
            "name": "Conditional Access Change Comparison",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap3"
      },
      "name": "Conditional Access Monitoring"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "18302244-0cfb-46d8-92e2-554fa9974c38",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "description": "Select at least one workspace that contains continuous export data based on the selected subscriptions",
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "CAPTime",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": "/subscriptions/d75e3576-9a3a-4f5b-b112-b5e0088cd2e1/resourceGroups/Sentinel/providers/Microsoft.OperationalInsights/workspaces/Sentinel-Cyberlorians"
          },
          {
            "id": "9943b4a1-371e-4e50-8cbe-749a6dd87d76",
            "version": "KqlParameterItem/1.0",
            "name": "Time",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ]
            },
            "value": {
              "durationMs": 2592000000
            }
          },
          {
            "id": "6cda824d-697b-4979-856a-7a8ad38cdac9",
            "version": "KqlParameterItem/1.0",
            "name": "UserPrincipalName",
            "type": 1,
            "description": "Type username prefix and any search will be found",
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "CAPTime",
            "value": ""
          },
          {
            "id": "6bb643b3-3b3e-4f99-baa6-ec58a81d26a2",
            "version": "KqlParameterItem/1.0",
            "name": "Application",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "SigninLogs \r\n| extend AzureADApplication = AppDisplayName\r\n| where isnotempty(AzureADApplication)\r\n| distinct AzureADApplication\r\n| sort by AzureADApplication asc ",
            "crossComponentResources": [
              "{Workspace}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "Time",
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "81b4afa7-4b18-48fa-832b-472d57272577",
            "version": "KqlParameterItem/1.0",
            "name": "Policy",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend displayName_ = tostring(ConditionalAccessPolicies.displayName)\r\n| distinct displayName_\r\n| sort by displayName_ asc\r\n",
            "crossComponentResources": [
              "{Workspace}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "Time",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "b7cbfc9c-e9a9-4ce5-9a5f-95889b873e83",
            "version": "KqlParameterItem/1.0",
            "name": "Report",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "SigninLogs \r\n| mv-expand ConditionalAccessPolicies\r\n| extend CAResult = tostring(ConditionalAccessPolicies.result)\r\n| distinct CAResult",
            "crossComponentResources": [
              "{Workspace}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "Time",
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap1"
      },
      "name": "Param1"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\n| mv-expand ConditionalAccessPolicies\n| extend Result = tostring(ConditionalAccessPolicies.result)\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\n| where ['PolicyName'] in ({Policy})\n| extend AzureADApplication = AppDisplayName\n| where AzureADApplication in ({Application})\n| extend Result = tostring(ConditionalAccessPolicies.result)\n| where Result in ({Report}) or '*' in ({Report})\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\n| project Result\n| summarize count() by Result\n\n",
              "size": 2,
              "showAnalytics": true,
              "title": "\"SignIn Summaries\" By Parameters Set",
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Result",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  }
                },
                "showBorder": false,
                "sortCriteriaField": "Result",
                "size": "full"
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "Result",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "customWidth": "25",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "cap1"
            },
            "showPin": true,
            "name": "\"SignIn Summaries\" By Parameters Set"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where ['PolicyName'] in ({Policy})\r\n| extend AzureADApplication = AppDisplayName\r\n| where AzureADApplication in ({Application})\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| where Result in ({Report}) or '*' in ({Report})\r\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\r\n| summarize count() by Location\r\n",
              "size": 3,
              "title": "\"SignIn Summaries\" By Parameters Set",
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Location",
                "latitude": "Location",
                "longitude": "Location",
                "sizeSettings": "Location",
                "sizeAggregation": "Sum",
                "labelSettings": "Location",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "Location",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "magenta"
                }
              }
            },
            "customWidth": "75",
            "showPin": true,
            "name": "\"SignIn Summaries\" By Parameters Set"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where ['PolicyName'] in ({Policy})\r\n| extend AzureADApplication = AppDisplayName\r\n| where AzureADApplication in ({Application})\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| where Result in ({Report}) or '*' in ({Report})\r\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\r\n| extend device = tostring(DeviceDetail[\"operatingSystem\"])\r\n| where isnotempty(device)\r\n| summarize count() by UserPrincipalName, device\r\n| summarize count() by device",
              "size": 0,
              "showAnalytics": true,
              "title": "Device Platform - By Parameters Set",
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "device",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "Device Total - By Parameters Set"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where ['PolicyName'] in ({Policy})\r\n| extend AzureADApplication = AppDisplayName\r\n| where AzureADApplication in ({Application})\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| where Result in ({Report}) or '*' in ({Report})\r\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\r\n| extend deviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n| summarize count() by deviceState\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Device State - By Parameters Set",
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "deviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "Device State - By Parameters Set"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where ['PolicyName'] in ({Policy})\r\n| extend AzureADApplication = AppDisplayName\r\n| where AzureADApplication in ({Application})\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| where Result in ({Report}) or '*' in ({Report})\r\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\r\n| summarize count() by RiskLevelDuringSignIn",
              "size": 0,
              "showAnalytics": true,
              "title": "Sign-in Risk - By Parameters Set",
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "RiskLevelDuringSignIn",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "SignIn-Risk - By Parameters Set"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where ['PolicyName'] in ({Policy})\r\n| extend AzureADApplication = AppDisplayName\r\n| where AzureADApplication in ({Application})\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| where Result in ({Report}) or '*' in ({Report})\r\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\r\n| summarize count() by ClientAppUsed",
              "size": 0,
              "showAnalytics": true,
              "title": "Client App - By Parameters Set",
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "ClientAppUsed",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "Client App Used - By Parameters Set"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap1"
      },
      "name": "CAVizGroup"
    },
    {
      "type": 1,
      "content": {
        "json": "## Conditional Access Reporting\r\n\r\n#### *Below are the report types of Conditional Access. The layout of the results are meant as data points to take to the [whatif - tool](https://learn.microsoft.com/en-us/entra/identity/conditional-access/what-if-tool). Utilize the tool in Commerical [whatif](https://entra.microsoft.com/#view/Microsoft_AAD_ConditionalAccess/WhatIfBlade) or Government [whatif](https://entra.microsoft.us/#view/Microsoft_AAD_ConditionalAccess/WhatIfBlade).  For further insights, expand the results and select an item to view the detailed output.*\r\n\r\n#### **Success** -  The configured policy has successfully accessed a resource that is protected by a Conditional Access policy. This means that the user met all the conditions specified in the policy, such as having the right device, being in the right location, or having the right security settings, and was therefore granted access to the resource.\r\n\r\n#### **Failure** - A resource in this context of the configured policy was not able to access a resource that is protected by a Conditional Access Policy. This means the attempting resource did not meet conditions of the policy.\r\n\r\n#### **NotEnabled** - The configured policy and conditions are disabled.\r\n\r\n#### **NotApplied** - The configured policy has not been assigned (enforced) to any user or group in question.\r\n\r\n#### **Report-only: Success** - All configured policy conditions, required non-interactive grant controls, and session controls were satisfied. For example, a multifactor authentication requirement is satisfied by an MFA claim already present in the token, or a compliant device policy is satisfied by performing a device check on a compliant device.\r\n\r\n#### **Report-only: Failure** - All configured policy conditions were satisfied but not all the required non-interactive grant controls or session controls were satisfied. For example, a policy applies to a user where a block control is configured, or a device fails a compliant device policy.\r\n\r\n#### **Report-only: User action required** - All configured policy conditions were satisfied but user action would be required to satisfy the required grant controls or session controls. With report-only mode, the user isn't prompted to satisfy the required controls. For example, users aren't prompted for multifactor authentication challenges or terms of use.\r\n\r\n#### **Report-only: Not applied** -\tNot all configured policy conditions were satisfied. For example, the user is excluded from the policy or the policy only applies to certain trusted named locations.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap1"
      },
      "name": "text - 9"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| extend AzureADApplication = AppDisplayName\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| extend LocationName = tostring(parse_json(tostring(parse_json(NetworkLocationDetails)[0].networkNames))[0])\r\n| where AzureADApplication in ({Application})\r\n| where UserPrincipalName contains_cs ('{UserPrincipalName}')\r\n| where ['PolicyName'] in ({Policy})\r\n| where Result in ({Report}) or '*' in ({Report})\r\n| mv-expand DeviceDetail\r\n| extend Browser = tostring(DeviceDetail.browser), DeviceID = tostring(DeviceDetail.deviceId),DevicePlatform = tostring(DeviceDetail.operatingSystem), Managed = tostring(parse_json(DeviceDetail).isManaged), Trust = tostring(parse_json(DeviceDetail).trustType), DeviceName = tostring(parse_json(DeviceDetail).displayName)\r\n| extend [\"User risk level\"] = RiskLevelAggregated\r\n| extend [\"Sign-in risk level\"] = RiskLevelDuringSignIn\r\n//| where isnotempty(DevicePlatform) //may have to remove this\r\n| distinct TimeGenerated, UserPrincipalName, AppDisplayName, IP = IPAddress, Country = Location, DevicePlatform, ['PolicyName'], ClientAppUsed, [\"Sign-in risk level\"], [\"User risk level\"], Result, ['Grant Control']= tostring(ConditionalAccessPolicies.enforcedGrantControls)\r\n| sort by TimeGenerated desc\r\n\r\n",
              "size": 2,
              "showAnalytics": true,
              "title": "Conditional Access Results - Chose A 'Selected Time' For Detailed Correlation",
              "timeContextFromParameter": "Time",
              "showRefreshButton": true,
              "exportedParameters": [
                {
                  "fieldName": "TimeGenerated",
                  "parameterName": "Time2",
                  "defaultValue": "{ \"Name\":\"\", \"Type\":\"*\", \"Parent\":\"*\"}"
                },
                {
                  "fieldName": "Result",
                  "parameterName": "result2",
                  "parameterType": 1
                },
                {
                  "fieldName": "PolicyName",
                  "parameterName": "pol2",
                  "parameterType": 1
                }
              ],
              "showExportToExcel": true,
              "exportToExcelOptions": "all",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "$gen_group",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  },
                  {
                    "columnMatch": "UserPrincipalName",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AppDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "IP",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "Country",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "15ch"
                    }
                  },
                  {
                    "columnMatch": "PolicyName",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Result",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "$gen_group",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  }
                ],
                "rowLimit": 1000,
                "filter": true,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "Result",
                    "PolicyName",
                    "UserPrincipalName"
                  ],
                  "expandTopLevel": false
                }
              },
              "sortBy": [],
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "CA Policy Name",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "failure",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "sizeSettings": "failure",
                "sizeAggregation": "Sum",
                "legendMetric": "failure",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "type": "heatmap",
                  "colorAggregation": "Sum",
                  "nodeColorField": "failure",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "cap1"
            },
            "showPin": false,
            "name": "Conditional Access Results - Chose A 'Selected Time' For Detailed Correlation",
            "styleSettings": {
              "margin": "25",
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend ['PolicyName'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where ['PolicyName'] == \"{pol2}\"\r\n| extend Result = tostring(ConditionalAccessPolicies.result)\r\n| where Result == \"{result2}\"\r\n| where TimeGenerated == \"{Time2}\"\r\n| extend AuthDetails = parse_json(AuthenticationDetails)\r\n| mv-expand AuthDetails\r\n| extend AuthNMethod = tostring(AuthDetails.authenticationMethod), AuthNStepReq = tostring(AuthDetails.authenticationStepRequirement), AuthNStepResultDetails = tostring(AuthDetails.authenticationStepResultDetail), Succession = tostring(AuthDetails.succeeded)\r\n| project TimeGenerated, ['PolicyName'], UserPrincipalName, AuthNMethod, AuthNStepReq, AuthNStepResultDetails, Succession, Result, ResultType, ResultDescription\r\n| sort by TimeGenerated desc",
              "size": 1,
              "showAnalytics": true,
              "title": "Conditional Access Results Correlation By SelectedTime",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "exportToExcelOptions": "all",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "$gen_group",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  },
                  {
                    "columnMatch": "PolicyName",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "UserPrincipalName",
                    "formatter": 5
                  }
                ],
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "PolicyName",
                    "UserPrincipalName",
                    "Result"
                  ],
                  "expandTopLevel": false,
                  "finalBy": "Result"
                }
              },
              "sortBy": []
            },
            "conditionalVisibilities": [
              {
                "parameterName": "Time2",
                "comparison": "isNotEqualTo"
              },
              {
                "parameterName": "result2",
                "comparison": "isNotEqualTo",
                "value": ""
              },
              {
                "parameterName": "pol2",
                "comparison": "isNotEqualTo"
              }
            ],
            "showPin": true,
            "name": "Conditional Access Results Correlation By SelectedTime",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap1"
      },
      "name": "CAGroup"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "SigninLogs\r\n| mv-expand ConditionalAccessPolicies\r\n| extend CAResult = tostring(ConditionalAccessPolicies.result)\r\n| extend ['CA Policy Name'] = tostring(ConditionalAccessPolicies.displayName)\r\n| where RiskLevelDuringSignIn <> \"none\" or RiskState <> \"none\"\r\n| union\r\nAADUserRiskEvents\r\n| project TimeGenerated, UserPrincipalName, RiskDetail, RiskEventType, RiskLevel, RiskState, ['CA Policy Name']\r\n| sort by TimeGenerated desc",
        "size": 0,
        "showAnalytics": true,
        "title": "Conditional Access Risk Details",
        "timeContextFromParameter": "Time",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "75ch"
              }
            },
            {
              "columnMatch": "UserPrincipalName",
              "formatter": 5
            },
            {
              "columnMatch": "CA Policy Name",
              "formatter": 5
            },
            {
              "columnMatch": "$gen_group",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "75ch"
              }
            }
          ],
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "UserPrincipalName"
            ],
            "finalBy": "CA Policy Name"
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap1"
      },
      "showPin": true,
      "name": "Conditional Access Risk Details"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "SigninLogs\r\n| project TimeGenerated, ConditionalAccessPolicies, UserPrincipalName, AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| extend CAResult = tostring(ConditionalAccessPolicies.result)\r\n| extend CAPolicyName = tostring(ConditionalAccessPolicies.displayName)\r\n| where CAResult == \"failure\"\r\n| summarize\r\n    ['List of Failed Application']=make_set(AppDisplayName),\r\n    ['Count of Failed Application']=dcount(AppDisplayName)\r\n    by UserPrincipalName, bin(TimeGenerated, 1h)\r\n| where ['Count of Failed Application'] >= 5",
        "size": 2,
        "showAnalytics": true,
        "title": "Conditional Access Block to 5+ Apps within 1 Hour",
        "timeContextFromParameter": "Time",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "UserPrincipalName",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Count of Failed Application",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "cap1"
      },
      "showPin": true,
      "name": "Conditional Access Block to 5+ Apps within 1 Hour"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/d75e3576-9a3a-4f5b-b112-b5e0088cd2e1/resourcegroups/sentinel/providers/microsoft.operationalinsights/workspaces/sentinel-cyberlorians"
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
